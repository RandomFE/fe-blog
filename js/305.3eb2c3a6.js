"use strict";(self["webpackChunkfe100"]=self["webpackChunkfe100"]||[]).push([[305],{3305:function(s,a,t){t.r(a),t.d(a,{default:function(){return _}});var r=function(){var s=this,a=s.$createElement;s._self._c;return s._m(0)},e=[function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("section",[t("html",[t("head"),t("body",[t("h1",[s._v("Worker多线程")]),t("h2",[s._v("1. 原生JS多线程")]),t("blockquote",[t("p",[s._v("页面运行worker，限制了worker.js需要与页面同源。本地js代码可以借助URL.createObjectURL和Data URL的方式规避")])]),t("h3",[s._v("1.1 URL.createObjectURL")]),t("blockquote",[t("p",[s._v("vue-worker等库一般借助于URL.createObjectURL创建本地js文件的方式规避同源限制.")])]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[s._v("<script>\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 1.定义多线程实际运行的函数")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("threadFn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("a, b, c")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 可以传递初始化参数，但参数应尽量通过onmessage传递")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Worker Thread | receive initial args:'")]),s._v(", a, b, c)\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// worker进程内通过self调用context方法，不能使用this")]),s._v("\n    self."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("onmessage")]),s._v(" = "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("e")]),s._v(") =>")]),s._v(" {\n      "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Worker Thread | onmessage:'")]),s._v(", e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n\n      "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Worker Thread | postMessage:'")]),s._v(", e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n      self."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("postMessage")]),s._v("(e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n    }\n  }\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 2.定义worker创建方法：传入多线程运行函数和初始参数，创建worker")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createWorker")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("fn, ...params")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 将多线程函数转字符串")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" fnStr = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`("),t("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${fn.toString()}")]),s._v(")("),t("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${[...params]}")]),s._v(")`")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("warn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Main Thread | thread function string:'")]),s._v(", fnStr)\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// worker必须使用页面同源的js，此处借助URL.createObjectURL转换")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" blob = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Blob")]),s._v("([fnStr])\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" url = "),t("span",{pre:!0,attrs:{class:"hljs-variable constant_"}},[s._v("URL")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createObjectURL")]),s._v("(blob)\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 优化：URL.createObjectURL创建的资源必须手动通过URL.revokeObjectURL释放，否则需要刷新Browser Context时才会被释放")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" worker = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Worker")]),s._v("(url)\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" worker\n  }\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 3.实例化worker")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" c = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("\"'c'\"")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 线程创建传递初始化参数。注意，字符串常量需要两重引号包裹，否则函数转字符串会解析异常。建议通过postMessage传递数据")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" worker = "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createWorker")]),s._v("(threadFn, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("\"'aaa'\"")]),s._v(", c, "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("111")]),s._v(")\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 4.定义外层worker数据首发")]),s._v("\n  worker."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("onmessage")]),s._v(" = "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("e")]),s._v(" =>")]),s._v(" {\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("warn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Main Thread | onmessage:'")]),s._v(", e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(" === "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'terminate'")]),s._v(") {\n      "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("terminate")]),s._v("()\n    }\n  }\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 5.向worker发送数据")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("warn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Main Thread | postMessage:'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'main'")]),s._v(")\n  worker."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("postMessage")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'main'")]),s._v(")\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 6.注销worker")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("terminate")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}}),s._v(") {\n    worker."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("terminate")]),s._v("()\n    worker = "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("null")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("warn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Main Thread | worker has been terminated'")]),s._v(")\n  }\n\n  "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("setTimeout")]),s._v("(("),t("span",{pre:!0,attrs:{class:"hljs-function"}},[s._v("() =>")]),s._v(" {\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("warn")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Main Thread | postMessage:'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'terminate'")]),s._v(")\n    worker."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("postMessage")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'terminate'")]),s._v(")\n  }), "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1000")]),s._v(")\n<\/script>\n")])]),t("h3",[s._v("1.2 Data URL")]),t("blockquote",[t("p",[s._v("除了URL.createObjectURL外，还可以通过Data URL实现。通过Data URL运行的js函数不能省略语句的分号")])]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("threadFn")]),s._v(" () {\n  "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'worker | init thread'")]),s._v(");\n\n  self."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("postMessage")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'create success'")]),s._v(");\n}\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createWorker")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("fn")]),s._v(") {\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" worker = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Worker")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`data:,("),t("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${fn.toString()}")]),s._v(")()`")]),s._v(")\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" worker\n}\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" worker = "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createWorker")]),s._v("(threadFn)\nworker."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("onmessage")]),s._v(" = "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("e")]),s._v(" =>")]),s._v(" {\n  "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'main | onmessage'")]),s._v(", e."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n}\n")])])])])])}],n=t(3736),l={},p=(0,n.Z)(l,r,e,!1,null,null,null),_=p.exports}}]);
//# sourceMappingURL=305.3eb2c3a6.js.map